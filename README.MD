# Сервис пользовательской системы на FastAPI

Сервис реализует базовые операции управления пользователями и аутентификацию на базе JWT. Доступ к ресурсам предоставляется только при наличии соответствующих прав, в противном случае возвращаются корректные HTTP ошибки (401 или 403).

## Стек технологий

* Python
* FastAPI
* Pydantic
* SQLAlchemy
* PostgreSQL
* pyjwt

## Реализованный функционал

Реализованы следующие сценарии взаимодействия с пользователем:

* регистрация
* вход в систему
* выход из системы
* получение информации о пользователе по JWT токену
* обновление профиля пользователя по JWT токену
* удаление пользователя по JWT токену

## Аутентификация и JWT токены

Система использует два типа JWT токенов:

* `access` токен для авторизации запросов к защищенным ресурсам
* `refresh` токен для обновления access токена при истечении срока его действия

При истечении срока действия `access` токена доступно обновление путем запроса на соответствующий endpoint.

JWT токены подписываются алгоритмом RS-256:

* приватный ключ используется для выпуска и подписи токенов
* публичный ключ используется для проверки подписи и декодирования данных

Модель хранения токенов:

* `access` токен хранится на стороне клиента
* `refresh` токен хранится на стороне backend в `httponly` cookies

## Контроль доступа и ошибки авторизации

API возвращает ресурс только в случае успешной авторизации и наличия прав доступа.

Правила выдачи ошибок:

* 401 Unauthorized:
  * если срок действия `access` токена истек
  * если введены неверные учетные данные (email и password)
  * если ресурс требует авторизации, но токен не передан
  * если по входящему запросу невозможно определить пользователя
* 403 Forbidden:
  * если пользователь определен, но не имеет прав на получение или изменение ресурса

## Активность пользователя

Пользовательская модель содержит поле `is_active`, позволяющее на уровне системы определять статус активности пользователя.

Логика работы:

* если `is_active=true`, пользователь может совершать разрешенные ему действия
* если `is_active=false`, пользователь не может совершать действия в системе, кроме тех, которые специально предусмотрены для неактивных пользователей

## Роли и пермишены

Пользовательская модель поддерживает роль администратора. При необходимости на конкретные endpoints можно назначать ограничение на доступ только для администратора.

Для создания новых пермишенов реализован декоратор. При необходимости можно определить функцию с нужным условием и обернуть ее декоратором:

`@permission(msg="...")`

Сообщение `msg` используется для формирования информативной ошибки при отсутствии прав.

## Обработка ошибок

Реализованы кастомные глобальные обработчики ошибок, которые унифицируют формат ответа и корректно выставляют HTTP статус.

Также реализованы кастомные исключения, включая:

* `UserNotActiveException`
* `InvalidCredentialsError`
* `CustomDatabaseError`

## Документация API

В Swagger документации описаны основные ограничения, требования к авторизации, а также возможные ошибки для запросов, включая 401, 403 и другие.

## Дополнительно

Реализовано базовое mock представление для регистрации пользователя.

## Локальный запуск проекта

```bash
git clone https://github.com/ordenmeny/User-Service-EM.git
```
```bash
cd User-Service-EM
```

### Установите uv (пакетный менеджер python) 
#### На Linux/Mac OS (через curl):
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

#### На Windows (через PowerShell):
```bash
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### Установите версию python:
```bash
uv python pin 3.13
```

### Установите зависимости:
```bash
uv sync
```

### Сгенерируйте приватные и публичные ключи
Сгенерировать приватный ключ:
```bash
openssl genrsa -out jwt-private.pem 2048
```
Сгенерировать публичный ключ на основе приватного:
```bash
openssl rsa -in jwt-private.pem -outform PEM -pubout -out jwt-public.pem
```
#### После этого поместите их в директорию certs (на том же уровне, что и app), например. Пути можно поменять в файле app/core/config.py

### Настройка переменных окружения:
создайте в корне проекта файл .env и поместите туда необходимые переменные (например, те, что содержатся в .env.example).

### Разверните базу данных (postgres) + pgadmin, например, через Docker:
```bash
docker compose up -d
```

### Создать миграции (если их не было) и применить их.
```bash
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head
```

### Запустить проект через uvicorn (или через IDE, нажав кнопку запуска в файле app/main.py):
```bash
uv run uvicorn app.main:app --reload
```

### Для просмотра документации и ендпоинтов перейдите по адресу:
```http
http://127.0.0.1:8000/docs/
```

